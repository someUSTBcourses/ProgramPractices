# 程序设计实践项目 - 简单的Web Server实现

## 任务要求：

搭建HTTP协议的Web 服务器开发。支持使用浏览器连接到自己建立的Web Server；Web Server可以返回静态网页和动态网页，页面包括：

1. 登录页面（<font color=red>login.html</font>）：输入用户名与密码，完成登录验证。
2. 出错页面（<font color=red>error.html</font>）：用户登录失败后的提示页面。
3. 导航页面（<font color=red>index.html</font>）：提供系统功能（日志查询、配置系统）的导航栏。
4. 配置系统页面（<font color=red>config.html</font>）：配置Web Server的IP地址、日志存储位置等信息。
5. 日志查询展示页面（动态页面）：输入查询条件获取相关日志信息，并将结果以表格呈现。

## 具体任务说明

### 任务1：构建Web Server服务器，在指定端口启动监听，等待用户的请求，并给出响应结果。

#### 步骤1：启动服务器。

1. 在指定端口建立监听程序。
   包含如下操作：定义服务器接口-->创建套接字-->设置套接字属性，复用端口-->绑定套接字和网络地址-->创建监听队列。
2. 建立多线程工作机制。
   包含如下操作：
   定义线程池类threadpool-->工作线程Jobthread创建-->Schedule函数添加任务队列-->关闭线程池

####  步骤2：监听浏览器端请求。

用listen函数将服务器套接字激活成等待请求状态，当有请求时提示服务器端读取请求，此时若客户端未关闭页面，请求包为空，服务器会一直等待新的请求。
     

#### 步骤3：接收HTTP请求。

包含如下操作：读取请求包-->按报文格式读取获取表单数据，支持get和post两种请求方式。

####  步骤4：给出HTTP响应。

包含如下操作：查看响应类型，根据不同响应类型解析发送响应结果。
说明：步骤1、2功能已经提供，3、4需要独立开发。步骤1、2线程池类浏览顺序如下：

    http请求：读取请求包-->按报文格式读取获取表单数据（get在url，post在请求体）

需要获取请求可先看http_get_line()读一行字符串（get、post都相同,建议截掉前缀后缀方便后期取用），接着可看http_accept_request()解析请求包部分（isspace()获取请求类型）。

    http响应：查看后缀根据不同文件类型解析发送-->发送请求包

发送响应包需知道http协议要求，发送头信息可参考http_headers()，获取文件类型可参考http_head_type(字符串截取后缀名并匹配)，

- 发送请求所需文件参考GET请求:http_server_file(),
- POST请求http_server_file_post，了解POST请求体概念。
- 线程池实现：创建并初始化线程池定义一个线程池类thread_pool—>工作线程thread_job创建Schedule函数添加任务队列关闭线程池
  线程池原理：提前建立若干个线程，在没有工作的情况下让其休眠，当有任务来时，唤醒其中一个线程去执行这项任务，完成后再让其休眠，每个线程都在等待一个信号量来唤醒自己，当一个线程获取到一个信号量时，它从任务队列中取出一个任务来进行执行，执行完后再查看还有无信号量，如果没有，就继续休眠。如下图：

![输入图片说明](Images/%E7%BA%BF%E7%A8%8B1.png)


线程池类thrad_pool主要包括create_pool(),Schedule(),Destory()三个函数，具体功能见注释，以下为浏览顺序：了解原理后,主体结构先看thrad_pool类内创建线程池函数create_pool()，参数为线程数量，创建好带有若干个线程的线程池；接着看Schedule()将任务添加至任务队列，最后看销毁函数。

细节部分主要是两个结构体和锁：

- 结构体thread_job，这个是一个线程所要执行的一项工作，存在线程池的任务列表中。
- 结构体thread_item，这是一个线程的描述信息，包括了线程的句柄，是否在执行任务中，以及自己所属的线程池对象指针，这些信息将以线程的参数传递给工作线程。
- Mutex类为线程加锁，相关用途可参考网址：(8条消息) 互斥锁(mutex)_清风徐来Groot的博客-CSDN博客


### 任务2：用户登录验证。

#### 步骤1：请求登录。

用户在浏览器地址栏键入网址（如：http://web-server-IP/login.html）；Web Server返回静态网页login.html，页面提供填写用户名、密码的文本框和登录按钮；用户输入信息后，使用post请求方式将用户名和密码提交到Web Server端进行验证。

#### 步骤2：验证登录信息。

Web Server接收到用户身份验证请求后，选择通过常量字符串/文件数据验证用户的身份是合法用户；用户身份合法返回导航页面index.html，否则给出出错页面error.html，并返回login.html页面允许用户重新输入。

###  任务3：日志管理。

#### 步骤1：记录日志信息。

（1）在Web Server处理事务的过程中记录日志信息，自动创建日志，对服务器运行状态、错误信息和访问数据进行记录，实现按天分类，超行分类功能。
（2）实现过程中封装阻塞队列，将要写的日志信息push进队列，创建一个新线程，从队列中取出内容，写入日志文件。
（3）日志存储格式为“.txt”格式的文本文件，存储产生日志信息的日期时间及发生的异常情况记录。

#### 步骤2：日志查询。

技术要点：Web Server对查询的响应
（1）在日志查询页面以表格形式展示当天所记录日志
（2）在日志查询页面**的搜索框中输入查询条件→运用c++文件管理操作在日志文件中完成查询→将查询到的记录以表格形式呈现在logger.html
说明：步骤1代码已给出，将log.h、locker.h、block_queue.h、pthread库添加到工程即可。步骤2需通过阅读已给代码和查找资料自行完成。

### 任务4：配置系统参数。

#### 步骤1：在页面填写系统参数。

在config.html页面填写配置信息，可以配置的信息包括端口号、线程池大小等信息。

#### 步骤2：保存配置信息。

在config.html页面点击“保存”按钮后，将配置信息保存至**文件。

#### 步骤3：读取配置信息。

定义文件流对象ifstream config，将配置文件放至源文件同级文件夹内，config.open()打开文件后以读字符串的方式读取数据，与日志系统读取相似。

### 其他任务要求。

在已有系统及以上功能基础上，按照自己的想法扩充1-2个功能。
例如：增加记录日志的逻辑控制、丰富日志类型；增加系统的配置参数；将已注册用户信息保存至文件/数据库，按其中的数据进行登录验证；添加线程销毁逻辑等等。

## 项目包含的技术点。

1. 理解基于Socket的网络通信。
2. 理解多线程工作机制。
3. 理解HTTP协议。
4. 掌握B/S架构程序的工作原理，包括服务器端如何接收请求，并给出静态页面或者动态页面的响应结果。

## 项目重点考察知识点。

1. 通过Web Server系统架构，掌握C++面向对象编程思想，理解封装、继承、多态在复杂工程中的运用。
2. 通过日志文件、系统配置文件的操作，熟练掌握文件操作。
3. 通过处理HTTP请求和响应，熟练掌握字符串操作。

## 附录：

1.生成UML图方法：在Ubuntu下用Doxygen生成UML图.docx、使用Visual Studio 2022生成UML图.docx
2.日志系统头文件：log.h、locker.h、block_queue.h
3.日志系统locker.h中包含的外部pthread库：pthreads-w32-2-9-1-release
4.日志系统功能说明及pthread库配置方法：Web Server日志部分详细说明.docx
5.日志系统类图及程序注释文档：Log html（从index.html打开）


## 参与贡献

1. 朱博林
2. 王鹏浩
3. 张耀丹
4. 陈翔楠

特别感谢宋老师！


##  Gitee Feature

1.   针对题目要求，可以自己完成系统设计包括建立http server，建立多线程管理机制，实现日志记录等；建立静态和动态网页。
2.   针对题目要求和已经提供的代码，测试http server，并增加特定的页面功能